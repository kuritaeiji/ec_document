# API 一覧

## エンドユーザー

| API 名                                                                             | メソッド | パス                         | ログイン可否 | ミドルウェア | API を使用するページ                                     | 備考                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| :--------------------------------------------------------------------------------- | :------- | :--------------------------- | :----------: | :----------- | :------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| メールアドレスによって新規アカウントを登録する                                     | POST     | /account                     |      ×       |              | 新規アカウント登録ページ                                 | すでに同一メールアドレスかつ未認証のアカウントが存在する場合は、同一メールアドレスのアカウントを更新する                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 新規アカウント登録時のメールアドレスを認証する                                     | GET      | /account/email/auth          |      ×       |              | 認証メール                                               | カートを作成する・Stripe の Customer を作成する・ログインする                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 新規アカウント登録時のメールアドレスに認証メールを再送する                         | GET      | /account/email/resend        |      ×       |              | 新規アカウント登録ページの認証メールが届かない場合リンク |
| Google アカウントで新規アカウント登録する（Google ログイン画面へリダイレクトする） | GET      | /account/new/google          |      ×       |              | 新規アカウント登録の Goggle 新規登録ボタン               |
| Google アカウントで新規アカウント登録する（OIDC の JWT を受け取る）                | GET      | /account/new/google/redirect |      ×       |              | Google の認可サーバー                                    | Google アカウントのメールアドレスをアカウントのメールアドレスとして登録する・カートを作成する・Stripe の Customer を作成する・ログインする                                                                                                                                                                                                                                                                                                                                                                                           |
| Apple アカウントで新規アカウント登録する（Apple ログイン画面へリダイレクトする）   | GET      | /account/new/apple           |      ×       |              | 新規アカウント登録ページの Apple 新規登録ボタン          |
| Apple アカウントで新規アカウント登録する（OIDC の JWT を受け取る）                 | GET      | /account/new/apple/redirect  |      ×       |              | Apple の認可サーバー                                     | Apple アカウントのメールアドレスとアカウントのメールアドレスとして登録する・カートを作成する・Stripe の Customer を作成する・ログインする                                                                                                                                                                                                                                                                                                                                                                                            |
| アカウントを削除する                                                               | DELETE   | /account                     |      〇      |              | 退会するボタン                                           |
|                                                                                    |
| メールアドレス・パスワードでログインする                                           | GET      | /login                       |      ×       |              | 　ログインページ                                         |
| Google アカウントでログインする（Google ログイン画面へリダイレクトする）           | GET      | /login/google                |      ×       |              | 　ログインページ（Google でログインボタン）              |
| Google アカウントでログインする（OIDC の JWT を受け取る）                          | GET      | /login/google/redirect       |      ×       |              | Google の認可サーバー                                    |
| Apple アカウントでログインする（Apple ログイン画面へリダイレクトする）             | GET      | /login/apple                 |      ×       |              | ログインページ(Apple でログインボタン)                   |
| Apple アカウントでログインする（OIDC の JWT を受け取る）                           | GET      | /login/apple/redirect        |      ×       |              | Apple の認可サーバー                                     |
| ログアウトする                                                                     | DELETE   | /logout                      |      〇      |              | ログアウトボタン                                         |
|                                                                                    |
| 商品を検索する                                                                     | POST     | /products/search             |      ×       |              | 商品一覧ページ・トップページ・ヘッダー                   |
| 商品を 1 件取得する                                                                | GET      | /products/:id                |      ×       |              | 商品詳細ページ                                           |
|                                                                                    |
| 支払い方法一覧を取得する                                                           | GET      | /payment_methods             |      〇      |              | 購入ページ・支払い設定ページ                             |
| 支払い方法を追加する                                                               | POST     | /payment_method              |      〇      |              | 購入ページ・支払い設定ページ                             |
| 支払い方法を削除する                                                               | DELETE   | /payment_method/:id          |      〇      |              | 支払い設定ページ                                         |
| デフォルトで使用する支払い方法を更新す                                             | PUT      | /payment_method/:id          |      〇      |              | 支払い設定ページ                                         |
|                                                                                    |
| 住所一覧を取得する                                                                 | GET      | /addresses                   |      〇      |              | 購入ページ・住所設定ページ                               |
| 住所を追加する                                                                     | POST     | /address                     |      〇      |              | 購入ページ・住所設定ページ                               |
| 住所を削除する                                                                     | DELETE   | /address/:id                 |      〇      |              | 住所設定ページ                                           |
| デフォルトで使用する住所を更新する                                                 | PUT      | /address/:id/default         |      〇      |              | 住所設定ページ                                           |
| 住所を更新する                                                                     | PUT      | /address/:id                 |      〇      |              | 住所設定ページ                                           |
|                                                                                    |
| カート内の商品を購入する                                                           | POST     | /purchase                    |      〇      |              | 購入ページ                                               | カートに追加されたすべての商品の在庫レコードを悲観ロックする（デッドロック回避のためロックを取得できなかった場合はタイムアウトする）・カートは楽観ロックする・商品は楽観ロックする（購入中に商品の価格や販売ステータスが変化する可能性があるため。商品集約は更新しないため最初に取得した商品のバージョンと注文集約作成後の商品のバージョンが一致することを確認する）・カート内の商品の在庫が存在しないまたは販売中ではなく購入できない商品が存在する場合はカート内の商品を削除してエラーメッセージ返却する・商品購入メールも送信する |
|                                                                                    |
| 商品にいいねする                                                                   | POST     | /like                        |      〇      |              | 商品詳細ページ・カート詳細ページ                         |
| 特定の商品がいいねされているかを表示する                                           | GET      | /products/:id/like           |      〇      |              | 商品詳細ページ                                           |
| 商品のいいねを削除する                                                             | DELETE   | /like/product/:id            |      〇      |              | 商品詳細ページ・カート詳細ページ                         |
| いいね一覧を取得する                                                               | GET      | /likes                       |      △       |              | いいね一覧ページ                                         |
|                                                                                    |
| 商品をカートに追加する                                                             | PUT      | /cart/add_product            |      △       |              | 商品詳細ページ                                           | ログインしていない場合はセッションのカートに追加し（セッションのカートが存在していない場合は作成する）、ログインしている場合は DB のカートに追加する                                                                                                                                                                                                                                                                                                                                                                                 |
| カート内の商品一覧を取得する                                                       | GET      | /cart                        |      △       |              | カート詳細ページ                                         | 販売停止中・販売終了・在庫がない商品をカートから削除する・在庫が 1 で購入希望数量が 2 だった場合は商品の数量を 1 に更新する                                                                                                                                                                                                                                                                                                                                                                                                          |
| カート内の商品を削除する                                                           | DELETE   | /cart/product/:id            |      △       |              | カート詳細ページ                                         |
| カート内の商品の購入数を更新する                                                   | PUT      | /cart/product/:id            |      △       |              | カート詳細ページ                                         |
|                                                                                    |
| 投稿したレビュー一覧を取得する                                                     | GET      | /reviews/account/:id         |      △       |              | レビュー一覧ページ                                       | 他アカウントのレビュー一覧を取得可能・他アカウントのレビュー一覧を取得する場合はログインの必要はないが自アカウントのレビューを取得する場合はログインの必要あり                                                                                                                                                                                                                                                                                                                                                                       |
| 商品に対するレビュー一覧を取得する                                                 | GET      | /reviews/product/:id         |      ×       |              | 商品詳細ページ                                           |
| 投稿したレビューを 1 件取得する                                                    | GET      | /review/:id                  |      〇      |              | レビュー作成・編集ページ                                 |
| 購入した商品にレビューする                                                         | POST     | /review/product/:id          |      〇      |              | レビュー作成・編集ページ                                 |
| 投稿したレビューを編集する                                                         | PUT      | /review/:id                  |      〇      |              | レビュー作成・編集ページ                                 |
| 投稿したレビューを削除する                                                         | DELETE   | /review/:id                  |      〇      |              | レビュー一覧ページ・レビュー作成・編集ページ             |
| レビュー投稿者名を編集する                                                         | PUT      | /account/review_poster_name  |      〇      |              | レビュー作成・編集ページ                                 |
|                                                                                    |
| 注文履歴一覧を取得する                                                             | GET      | /order_histories             |      〇      |              | 注文履歴一覧ページ                                       |
| キャンセルする                                                                     | POST     | /cancel                      |      〇      |              | 注文キャンセルページ                                     | 注文レコードを楽観ロックする（システム管理者も商品を発送することで注文ステータスを更新できるので衝突しないようにする）注文に複数の注文明細が含まれる場合注文明細単位でキャンセル可能                                                                                                                                                                                                                                                                                                                                                 |
|                                                                                    |
| 本日の発送日数を取得する                                                           | GET      | /shipping_days               |      ○       |              | トップページ・購入ページ                                 |
|                                                                                    |
| ヘルスチェック                                                                     | GET      | /healthcheck                 |      ×       |              |                                                          | ロードバランサーのヘルスチェック用 API                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |

## システム管理者

| API 名                     | メソッド | パス               | ログイン可否 | ミドルウェア | API を使用するページ | 備考                                                                                                                                                                          |
| :------------------------- | :------- | :----------------- | :----------- | :----------- | :------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ログインする               | POST     | /login             | ×            |              | ログインページ       |
| ログアウトする             | DELETE   | /logout            | 〇           |              | ログアウトボタンン   |
|                            |
| 商品を登録する             | POST     | /product           | 〇           |              | 商品登録ページ       |
| 商品を検索する             | POST     | /products/search   | 〇           |              | 商品検索ページ       |
| 商品を更新する             | PUT      | /product/:id       | 〇           |              | 商品編集ページ       | 在庫は編集できない（エンドユーザーが商品を購入する場合も在庫を排他ロックするためロック待ちにならないように商品編集時には排他制御させず在庫編集は別 API にする）楽観ロックする |
| 在庫を編集する             | PUT      | /product/:id/stock | 〇           |              | 在庫編集ページ       |
| 注文を検索する             | POST     | /orders/search     | 〇           |              | 注文検索ページ       |
| 注文のステータスを更新する | PUT      | /order/:id/status  | 〇           |              | 注文検索ページ       | 注文レコードを楽観ロックする（エンドユーザーも注文をキャンセルすることでステータスを更新できるため衝突しないようにする）                                                      |
| 発送日数を更新する         | PUT      | /shipping_day      | 〇           |              | 発送日数更新ページ   |
| ヘルスチェック             | GET      | /healthcheck       | ×            |              |                      | ロードバランサーのヘルスチェック用 API                                                                                                                                        |

発送日数・カテゴリーの API も作成する

## バッチ

| バッチ名                                         | 実行タイミング | 備考 |
| :----------------------------------------------- | :------------- | :--- |
| 商品ごとのレビューの点数を平均して DB を更新する | 毎日 18:00     |
